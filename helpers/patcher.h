#ifndef _PATCHER_H
#define _PATCHER_H

#include <fcntl.h>
#include <stdint.h>
#include <sys/mman.h>

// Replace 0x0f05 (syscall) instruction in open library function by
// 0xcccc (int3; int3) instructions, i.e., not allow its execution
void patch_sysopen()
{
    uint8_t *open_ptr = (uint8_t *)&open;
    while (*open_ptr != 0x0f && *(open_ptr + 1) != 0x05)
        open_ptr++;

    uint8_t *aligned_open_ptr = open_ptr - ((uintptr_t)open_ptr & 0xfff);
    mprotect(aligned_open_ptr, 2, PROT_WRITE | PROT_EXEC);
    open_ptr[0] = 0xcc;
    open_ptr[1] = 0xcc;
    mprotect(aligned_open_ptr, 2, PROT_EXEC);
}
#endif /* _PATCHER_H */