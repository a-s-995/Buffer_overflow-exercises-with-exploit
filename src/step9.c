#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include "helpers/printer.h"
#include "helpers/lockdown.h"
#include "helpers/flag.h"

//##############################################################################
// Function declarations
//##############################################################################
void initialize_flag();
int authorize();
void greetings();
int set_name();
void get_name();
void get_next_shift();
void load_flag();
void handle_input();

//##############################################################################
// COMMANDS
//##############################################################################
#define GET_FLAG 1
#define SHOW_BANNER 2
#define SET_NAME 3
#define GET_NAME 4
#define GET_NEXT_SHIFT 5
#define QUIT 9

//##############################################################################
// Global Variables
//##############################################################################
static char g_banner[32] = "Gate 9";
static char *g_name = NULL;
static char *g_flag = NULL;

//##############################################################################
// Function definitions
//##############################################################################
void initialize_flag()
{
    if (!g_flag && !(g_flag = malloc(32)))
    {
        printf("ERROR! out of memory.");
        exit(EXIT_FAILURE);
    }
    strncpy(g_flag, FLAG, 32);
}

int main(int argc, char const *argv[])
{
    set_buffering();
    lockdown_program();

    greetings();
    handle_input();
    return 0;
}

void handle_input()
{
    int user_input;
    do
    {
        printf_userinput("Input:");
        user_input = user_input_number();
        switch (user_input)
        {
        case GET_FLAG:;
            initialize_flag();
            if (authorize())
                load_flag();
            break;
        case SHOW_BANNER:
            greetings();
            break;
        case SET_NAME:
            set_name();
            break;
        case GET_NAME:
            get_name();
            break;
        case GET_NEXT_SHIFT:
            get_next_shift();
            break;
        case QUIT:
            // do-while condition will deal with it
            break;
        default:
            printf_user("Unknown option, try again\n");
        }
    } while (user_input != QUIT);
}

void greetings()
{
    header(g_banner);
    printf_userchoice(GET_FLAG, "Raise the flag");
    printf_userchoice(SHOW_BANNER, "Show the best banner");
    printf_userchoice(SET_NAME, "Input your name: _____________");
    printf_userchoice(GET_NAME, "See your registered name");
    printf_userchoice(GET_NEXT_SHIFT, "Check next guard shift time");
    printf_userchoice(QUIT, "Quit\n");
}

int set_name()
{
    int length = 0;
    int error = 0;
    if (!g_name && !(g_name = malloc(32)))
    {
        error = -EXIT_FAILURE;
        printf("ERROR! out of memory.");
        exit(EXIT_FAILURE);
    }
    printf_userinput("What can we call you?");
    fgets(g_name, 32, stdin);
    length = strnlen(g_name, 32);
    return error || length;
}

void get_name()
{
    int max_name_size = 32;
    int i;
    if (g_name)
    {
        while (g_name[i] && g_name[i] != '\n' && max_name_size--)
            fputc(g_name[i++], stdout);
        printf("\n\n");
    }
    else
    {
        printf_user("You have to set your name first.");
    }
}

void get_next_shift()
{
    int cur_time_minutes = 0;
    int cur_time_seconds = 0;
    time_t now = time(NULL);
    cur_time_seconds = now % 60;
    cur_time_minutes = now / 60 % 64;
    printf("Next change in: %02d minutes and %02d seconds\n\n", 60 - cur_time_minutes, 60 - cur_time_seconds);
}

int authorize()
{
    printf_user("You need to be authorized to read the flag");
    char username[0x40] = {0}, password[0x40] = {0};

    printf_userinput("Enter the username: ");
    fgets(username, 0x40, stdin);

    printf_userinput("Enter the password: ");
    fgets(password, 0x40, stdin);

    long authorized = !strcmp(username, "dumb") && !strcmp(username, "password");
    if (!authorized)
        printf_user("Authorization failed. You're not worthy of the flag.\n");
    return authorized;
}

void load_flag()
{
    if (g_flag)
        strncpy(g_banner, g_flag, 32);
}