#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <time.h>
#include "helpers/printer.h"
#include "helpers/lockdown.h"
#include "helpers/flag.h"
#include "helpers/segfaulthandler.h"
#include "helpers/bestrand.h"

//##############################################################################
// <Return Address XORing>
static uintptr_t g_canary = 0;
#define RET_ADDR_ENC() *((uintptr_t *)__builtin_frame_address(0) + 1) = g_canary ^ (uintptr_t)__builtin_return_address(0)
#define RET_ADDR_DEC() RET_ADDR_ENC()
// </Return Address XORing>
//##############################################################################

//##############################################################################
// Function declarations
//##############################################################################
int authorize();
void greetings();
void load_flag();
void handle_input();

//##############################################################################
// COMMANDS
//##############################################################################
#define GET_FLAG 1
#define SHOW_BANNER 2
#define QUIT 9

//##############################################################################
// Global Variables
//##############################################################################
static char g_banner[32] = "Border Patrol N3";

//##############################################################################
// Function definitions
//##############################################################################
int main(int argc, char const *argv[])
{
    set_buffering();
    register_segfault_handler();
    lockdown_program();

    // Randomize the canary every minute. Randomizing
    // more frequently will allow brute-force attacks
    bestsrand(time(NULL) / 60);
    g_canary = ((uintptr_t)bestrand() << 32) | bestrand();
    RET_ADDR_ENC();

    greetings();
    handle_input();

    RET_ADDR_DEC();
    return 0;
}

void handle_input()
{
    RET_ADDR_ENC();
    int user_input;
    do
    {
        printf_userinput("Input:");
        user_input = user_input_number();
        switch (user_input)
        {
        case GET_FLAG:;
            if (authorize())
                load_flag();
            break;
        case SHOW_BANNER:
            greetings();
            break;
        case QUIT:
            // do-while condition will deal with it
            break;
        default:
            printf_user("Unknown option, try again\n");
        }
    } while (user_input != QUIT);

    RET_ADDR_DEC();
}

void greetings()
{
    RET_ADDR_ENC();

    header(g_banner);
    printf_userchoice(GET_FLAG, "Raise the flag");
    printf_userchoice(SHOW_BANNER, "Show the best banner");
    printf_userchoice(QUIT, "Quit\n");

    RET_ADDR_DEC();
}

int authorize()
{
    RET_ADDR_ENC();

    printf_user("You need to be authorized to read the flag");
    char username[50], password[50];

    printf_userinput("Enter the username: ");
    best_gets(username);
    printf_userinput("Enter the password: ");
    best_gets(password);

    int authorized = !strcmp(username, "dumb") && !strcmp(username, "password");
    if (!authorized)
        printf_user("Authorization failed. You're not worthy of the flag.\n");

    RET_ADDR_DEC();

    return authorized;
}

void load_flag()
{
    RET_ADDR_ENC();

    strncpy(g_banner, FLAG, 32);

    RET_ADDR_DEC();
}